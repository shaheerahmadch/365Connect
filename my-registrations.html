<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shaheer Ahmad | Events</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://code.jquery.com/jquery-3.3.1.slim.min.js">
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.bundle.min.js">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

</head>

<body>
    <!-- The file upload popup -->
    <div id="file-fileUploadPopup" class="file-popup-overlay" style="display: none;">
        <div class="file-popup-container">
            <h2>Upload a File</h2>
            <label class="file-label" for="file-fileInput">Select File</label>
            <input type="file" id="file-fileInput" class="file-input" accept="image/jpeg, image/png, image/gif" />
            <p id="file-selectedFileName"></p>
            <button id="file-uploadButton" class="file-btn">Upload</button>
            <button id="file-closePopup" class="file-btn cancel">Cancel</button>
        </div>
    </div>

    <div class="loading" id="loading">Loading&#8230;</div>
    <div class="header" style="height: 50vh !important;">


        <div class="sides">
            <!-- search-->
            <a href="./index.html" class="logo">ðŸ”™ </a>
            <!-- search end-->
            <a href="./support.html" class="logo">Support Request</a>
        </div>


        <div class="sides">
            <a href="#" class="menu" style=" display: none;"> </a>


        </div>
        <div class="info" id="info">
            <div class="meta" style="margin-top: -60px !important;">
                <a href="" id="file-openPopup" target="_b" class="author1"></a><br>
            </div>
            <h4><a href="#category"></a></h4>
        </div>
    </div>

    <section class="content">
        <center>
            <h2 style="color: black !important;">Upcoming Event Registrations</h2>
            <hr style=" border: 2px solid black; border-radius: 20px;">
        </center>
        <ul id="event-list"></ul><br>
        <div class="message" id="message">
        </div>
        <br>
        <center>
            <h2 style="color: black !important;">Past Event Registrations</h2>
            <hr style=" border: 2px solid black; border-radius: 20px;">
        </center>
        <ul id="event-list1"></ul><br>
        <div class="row"></div>
        <div class="message" id="message1">
        </div>
        <!-- Popup and overlay for event details -->


    </section>
    <!-- Site footer -->
    <footer class="site-footer">
        <div class="container">
            <div class="row">
                <div class="col-sm-12 col-md-6">
                    <h6>About</h6>
                    <p class="text-justify">As a Microsoft Certified Professional and Microsoft Learn Student
                        Ambassador, I currently serve as a Power Platform & Dynamics 365 Associate Consultant at Cloud
                        Surge. My dedication lies in delivering practical and user-friendly solutions, and I have a
                        strong enthusiasm for learning and sharing knowledge. Active in the community, I find joy in
                        helping others solve problems and have started sharing my learnings on my blog.</p>
                </div>


                <div class="col-xs-6 col-md-3">
                    <h6>Quick Links</h6>
                    <ul class="footer-links">
                        <li><a href="http://scanfcode.com/about/">Community</a></li>
                        <li><a href="http://scanfcode.com/contact/">Blog</a></li>
                        <li><a href="http://scanfcode.com/contribute-at-scanfcode/">Instagram</a></li>
                        <li><a href="http://scanfcode.com/privacy-policy/">Community</a></li>
                        <li><a href="http://scanfcode.com/sitemap/">MLSA</a></li>
                    </ul>
                </div>
            </div>
            <hr>
        </div>
        <div class="container">
            <div class="row">
                <div class="col-md-8 col-sm-6 col-xs-12">
                    <p class="copyright-text">Copyright &copy; 2023 All Rights Reserved by
                        <a href="#">Shaheer Ahmad</a>.
                    </p>
                </div>

                <div class="col-md-4 col-sm-6 col-xs-12">
                    <ul class="social-icons">
                        <li><a class="facebook" href="#"><i class="fa fa-facebook"></i></a></li>
                        <li><a class="twitter" href="#"><i class="fa fa-twitter"></i></a></li>
                        <li><a class="linkedin" href="https://www.linkedin.com/in/shaheer-ahmad-ch"><i
                                    class="fa fa-linkedin"></i></a></li>
                    </ul>
                </div>
            </div>
        </div>
    </footer>
    <script>
        var crmUrl = "https://dev-shaheer.crm5.dynamics.com/";
        var imageurl = crmUrl + sessionStorage.getItem("image");
        console.log(imageurl)
        const authorElement = document.querySelector('.author1');
        if(sessionStorage.getItem("image") == '' || sessionStorage.getItem("image") == null || sessionStorage.getItem("image") == 'null' || sessionStorage.getItem("image") == 'undefined'){
            authorElement.style.background = 'url(https://static.vecteezy.com/system/resources/thumbnails/005/545/335/small/user-sign-icon-person-symbol-human-avatar-isolated-on-white-backogrund-vector.jpg) center no-repeat';
        } 
        else{
            authorElement.style.background = 'url('+imageurl+') center no-repeat';
        }
        

        // Change the background image URL
        

        // Optionally, you can also specify background size and box shadow here
        authorElement.style.backgroundSize = 'cover';
        authorElement.style.boxShadow = '0 2px 3px rgba(0, 0, 0, 0.3)';
        const sidesDiv = document.querySelector(".sides");
const anchorElement1 = document.createElement("a");

// Set the anchor's attributes
anchorElement1.href = "./login.html";
anchorElement1.className = "logo";
anchorElement1.style.marginTop = "0px";
anchorElement1.style.height = "40px";
anchorElement1.textContent = "Sign Out";
anchorElement1.addEventListener("click", function (event) {
    event.preventDefault();
    sessionStorage.setItem("name", null);
    sessionStorage.setItem("email", null);
    window.location.href = "./index.html";
});
sidesDiv.appendChild(anchorElement1);
        // Wrap your code in an async function
        async function fetchDataAndDisplay() {
            const url_string = window.location.href;
            const url = new URL(url_string);
            //   const email = url.searchParams.get("email");
            //   const fullname = url.searchParams.get("name");
            const email = sessionStorage.getItem("email");
            const fullname = sessionStorage.getItem("name");
            const heading = document.getElementById("info");
            const text = document.createElement("h2");
            const textsds = document.createElement("p");
            text.textContent = "Welcome, " + fullname;
            textsds.textContent = email;
            heading.appendChild(text);
            heading.appendChild(textsds);
            // Create headers with the email value
            const myHeaders = new Headers();
            myHeaders.append("email", email);

            const requestOptions = {
                method: 'GET',
                headers: myHeaders,
                redirect: 'follow'
            };

            const apiUrl = "https://prod-10.southeastasia.logic.azure.com:443/workflows/252f1afb2e2943abb0e38c820d33274b/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=8YhfmzychMhNg8o8e1nZpIIpgFHljJoY1LlqNXP9BjM";

            try {
                const events = await fetchEventData(apiUrl, requestOptions);

                // Display event list
                displayEventList(events);
            } catch (error) {
                console.log(error)
            } finally {
                document.getElementById("loading").style.display = "none";
            }

            // Function to fetch event data from the API
            async function fetchEventData(apiUrl, requestOptions) {
                try {
                    const response = await fetch(apiUrl, requestOptions);

                    if (response.status === 200) {
                        const data = await response.json();
                        return data;
                    } else {
                        showError("No Events Registered", "danger");
                    }
                } catch (error) {
                    showError("No Events Registered", "danger");
                }
            }


            // Function to create and display the event list
            function displayEventList(events) {
                const eventList = document.getElementById("event-list");
                const eventList1 = document.getElementById("event-list1");

                events.forEach(event => {
                    const listItem = document.createElement("li");
                    listItem.className = "event-item";
                    if (event["statuscode@OData.Community.Display.V1.FormattedValue"] != 'Pending') {
    //                     listItem.innerHTML = `<h1>${event["_sa_event_value@OData.Community.Display.V1.FormattedValue"]}</h1>
    //   <p><strong>Registered On:</strong> ${event["createdon@OData.Community.Display.V1.FormattedValue"]}</p>
    //   <p><strong>Attendee Name:</strong> ${event["_sa_attendee_value@OData.Community.Display.V1.FormattedValue"]}</p>
    //   <p><strong>Attendance:</strong> ${event["statuscode@OData.Community.Display.V1.FormattedValue"]}</p><br>
    //   <a href="./register.html?id=${event._sa_event_value}&reg=false" class="view-details" style="text-decoration: none !important;">View Details</a>
    // `;
    //                     eventList1.appendChild(listItem);
                        const parentElement = document.querySelector('.row');
                        const colSm6 = createColSm6(event);
                        parentElement.appendChild(colSm6);
                    } else {
                        listItem.innerHTML = `<h1>${event["_sa_event_value@OData.Community.Display.V1.FormattedValue"]}</h1>
      <p><strong>Registered On:</strong> ${event["createdon@OData.Community.Display.V1.FormattedValue"]}</p>
      <p><strong>Attendee Name:</strong> ${event["_sa_attendee_value@OData.Community.Display.V1.FormattedValue"]}</p>
      <p><strong>Attendance:</strong> ${event["statuscode@OData.Community.Display.V1.FormattedValue"]}</p><br>
      <a href="./register.html?id=${event._sa_event_value}&reg=false" class="view-details" style="text-decoration: none !important;">View Details</a>
    `;
                        eventList.appendChild(listItem);
                    }



                });
                const pendingEvents = events.filter(event => event["statuscode@OData.Community.Display.V1.FormattedValue"] === "Pending");
                const pendingEventCount = pendingEvents.length;
                const pendingEvents1 = events.filter(event => event["statuscode@OData.Community.Display.V1.FormattedValue"] != "Pending");
                const pendingEventCount1 = pendingEvents1.length;
                if(pendingEventCount == 0)
                showError("No Upcoming Events Registered","warning");
                if(pendingEventCount1 == 0)
                showError1("No Past Events Registered","warning");
            }

            // Function to convert hours to days
            function hoursToDays(hours) {
                if (hours >= 24) {
                    const days = Math.floor(hours / 24);
                    const remainingHours = hours % 24;
                    if (remainingHours !== 0) {
                        return `${days} days and ${remainingHours} hours`;
                    } else {
                        return `${days} days`;
                    }
                } else {
                    return `${hours} hours`;
                }
            }
        }
        function showError(alert, alertType) {
            var message = document.getElementById("message");
            var messagetext = document.createElement("div");
            messagetext.classList.add("alert")
            messagetext.classList.add("alert-" + alertType)
            messagetext.textContent = alert;
            message.appendChild(messagetext);
        }
        function showError1(alert, alertType) {
            var message = document.querySelector('.row');
            var messagetext = document.createElement("div");
            messagetext.classList.add("alert")
            messagetext.classList.add("alert-" + alertType)
            messagetext.textContent = alert;
            message.appendChild(messagetext);
        }

        // Call the async function to initiate the asynchronous operation
        fetchDataAndDisplay();


        function createColSm6(thisevent) {
            // Create a div element with the "col-sm-6" class
            const colDiv = document.createElement('div');
            colDiv.classList.add('col-sm-6');

            // Create a div element with the "card" class
            const cardDiv = document.createElement('div');
            cardDiv.style.boxShadow = "rgba(0, 0, 0, 0.24) 0px 3px 8px";
            cardDiv.classList.add('card', 'd-flex', 'flex-column');
            cardDiv.style.minHeight = '350px';
            cardDiv.style.margin = '10px';
            cardDiv.style.marginBottom = "20px";
            

            // Create a div element with the "card-body" class
            const cardBodyDiv = document.createElement('div');
            cardBodyDiv.classList.add('card-body');

            // Create a title element
            const titleElement = document.createElement('h2');
            titleElement.classList.add('card-title');
            titleElement.style.backgroundColor = "#1ab394";
            titleElement.style.color = "white";
            titleElement.style.height = "150px";
            titleElement.textContent = thisevent["_sa_event_value@OData.Community.Display.V1.FormattedValue"];

            // Create a paragraph element for text
            const textElement = document.createElement('p');
            textElement.classList.add('card-text');
            textElement.style.textAlign = "center";
            textElement.innerHTML = `<b>Registered On: </b>`+ thisevent["createdon@OData.Community.Display.V1.FormattedValue"];

            const textElement1 = document.createElement('p');
            textElement1.classList.add('card-text');
            textElement1.style.textAlign = "center";
            textElement1.innerHTML = `<b>Attendee Name: </b>`+ thisevent["_sa_attendee_value@OData.Community.Display.V1.FormattedValue"];

            const textElement2 = document.createElement('p');
            textElement2.classList.add('card-text');
            textElement2.style.textAlign = "center";
            textElement2.innerHTML = `<b>Attendance: </b>`+ thisevent["statuscode@OData.Community.Display.V1.FormattedValue"];

            // Create a button element
            const buttonElement = document.createElement('p');
            buttonElement.classList.add('view-details');
            buttonElement.style.backgroundColor = "#343a40";
            buttonElement.style.textAlign = "center"
            buttonElement.textContent = 'View Event';

            // Add a click event listener to the button
            buttonElement.addEventListener("click", () => {
                window.location.href = "./register.html?id="+thisevent._sa_event_value+"&reg=false";
            });

            // Append the button element to the card body
            cardBodyDiv.appendChild(buttonElement);

            // Append elements to build the structure
            cardBodyDiv.appendChild(titleElement);
            cardBodyDiv.appendChild(textElement);
            cardBodyDiv.appendChild(textElement1);
            cardBodyDiv.appendChild(textElement2);
            cardBodyDiv.appendChild(buttonElement);
            cardDiv.appendChild(cardBodyDiv);
            colDiv.appendChild(cardDiv);

            // Return the created col-sm-6 element
            return colDiv;
        }


        ////////
        const fileOpenPopupButton = document.getElementById('file-openPopup');
const fileUploadPopup = document.getElementById('file-fileUploadPopup');
const fileInput = document.getElementById('file-fileInput');
const uploadButton = document.getElementById('file-uploadButton');
const closePopupButton = document.getElementById('file-closePopup');
const selectedFileName = document.getElementById('file-selectedFileName');

// Prevent default navigation behavior
fileOpenPopupButton.addEventListener('click', (event) => {
    event.preventDefault();
    fileUploadPopup.style.display = 'flex';
});

closePopupButton.addEventListener('click', () => {
    fileUploadPopup.style.display = 'none';
});

fileInput.addEventListener('change', () => {
    if (fileInput.files.length > 0) {
        selectedFileName.textContent = `Selected File: ${fileInput.files[0].name}`;
    } else {
        selectedFileName.textContent = '';
    }
});

uploadButton.addEventListener('click', () => {
    document.getElementById("loading").style.display = "block";
    const selectedFile = fileInput.files[0];
    const userEmail = sessionStorage.getItem("email"); // Replace with the actual user's email

    if (selectedFile) {
        const formData = new FormData();
        formData.append('contents', selectedFile);

        const headers = new Headers();
        headers.append('email', userEmail);
        
        // Add other headers as needed

        // Replace 'your-api-endpoint' with the actual API endpoint
        fetch('https://prod-26.southeastasia.logic.azure.com:443/workflows/6205a3aedd854dac93fe8b0c6f760ec8/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=jbGar-dsbKN5DJIqlT7V6-RplSxRkEpnkIG3abjQJaU', {
            method: 'POST',
            body: formData,
            headers: headers
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
            document.getElementById("loading").style.display = "none";
        })
        .then(data => {
            let newimage_url = crmUrl +data.body.entityimage_url;
            sessionStorage.setItem("image",data.body.entityimage_url);
            window.location.reload();
            fileUploadPopup.style.display = 'none';
            document.getElementById("loading").style.display = "none";
        })
        .catch(error => {
            console.error('Error:', error);
            document.getElementById("loading").style.display = "none";
        });
    } else {
        alert('Please select a file to upload.');
        document.getElementById("loading").style.display = "none";
    }
});
    </script>


</body>

</html>