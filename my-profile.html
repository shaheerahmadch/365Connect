<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="description"
        content="365Connect is a community dedicated to promoting and advancing the adoption of Microsoft D365 and Power Platform technologies. Our primary goal is to foster a supportive environment where individuals can learn, teach, and collaborate on all things related to these powerful tools. Whether you're an experienced user or just starting out, we welcome members from any part of the globe to join us in our mission to promote and develop this community.">
    <meta name="author" content="Shaheer Ahmad">
    <link href="https://fonts.googleapis.com/css?family=Montserrat:100,200,300,400,500,600,700,800,900"
        rel="stylesheet">


    <!-- Bootstrap core CSS -->
    <link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

    <!-- Additional CSS Files -->
    <link rel="stylesheet" href="assets/css/fontawesome.css">
    <link rel="stylesheet" href="assets/css/templatemo-grad-school.css">
    <link rel="stylesheet" href="assets/css/owl.css">
    <link rel="stylesheet" href="assets/css/lightbox.css">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profile | 365Connect Community</title>
    <link rel="stylesheet" href="styles.css">

    <script src="vendor/jquery/jquery.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://code.jquery.com/jquery-3.3.1.slim.min.js">
    <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.bundle.min.js">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">

</head>

<body>
    <header class="main-header clearfix" role="header">
        <div class="logo">
            <img style="height: 50px; margin-right: 20px;;" src="./favicon.ico">
            <a href="#" style="text-decoration: none; font-size: 29px !important;"><em></em><span
                    style="color: #feb70c;">3</span><span style="color: #5ea904;">6</span><span
                    style="color: #04a0ed;">5</span><span style="color: white;">C</span><span
                    style="text-transform: lowercase;">onnect</span></a><!--#ce392c;-->
        </div>
        <a href="#menu" class="menu-link"><i class="fa fa-bars"></i></a>
        <nav id="menu" class="main-nav" role="navigation">
            <ul class="main-menu">
                <li><a style="text-decoration: none !important;" href="./index.html">Home</a></li>
                <!--
            <li class="has-submenu"><a href="#section2">About Us</a>
              <ul class="sub-menu">
                <li><a href="#section2">Who we are?</a></li>
                <li><a href="#section3">What we do?</a></li>
                <li><a href="#section3">How it works?</a></li>
                <li><a href="https://templatemo.com/about" rel="sponsored" class="external">External URL</a></li>
              </ul>
            </li>-->
                <!-- <li><a href="#section5">Video</a></li> -->
                <li><a style="text-decoration: none !important;" href="./events.html" class="external">Events</a></li>
                <li><a style="text-decoration: none !important;" href="./support.html" class="external">Support</a></li>
            </ul>
        </nav>
    </header>
    <div id="imagePopup" class="image-popup">
        <span class="image-close" onclick="closePopup()">&times;</span>
        <img src="" alt="Profile Picture" id="previewImage">
    </div>
    <!-- The file upload popup -->
    <div id="file-fileUploadPopup" class="file-popup-overlay" style="display: none;">
        <div class="file-popup-container">
            <h2>Change Profile Picture</h2>
            <label class="file-label" for="file-fileInput">Select File</label>
            <input type="file" id="file-fileInput" class="file-input" accept="image/jpeg, image/png, image/gif" />
            <p id="file-selectedFileName" style="color: black !important;"></p>
            <button id="file-uploadButton" class="file-btn">Upload</button>
            <button id="file-closePopup" class="file-btn cancel">Cancel</button>
        </div>
    </div>

    <div class="loading" id="loading">Loading&#8230;</div>
    <div class="header" style="height: 50vh !important;">


        <div class="sides">
            <!-- search-->
            <a href="./index.html" class="logo">ðŸ”™ </a>
        </div>


        <div class="sides">
            <a href="#" class="menu" style=" display: none;"> </a>


        </div>
        <div class="info" id="info">
            <div class="meta" style="margin-top: -60px !important;">
                <a href="" id="file-openPopup1" target="_b" class="author1"></a>
                <div class="edit-icon">
                    <i class="fa fa-pencil" style="font-size:20px;" id="file-openPopup"></i>
                    <!-- You can replace this with the appropriate icon class or image -->
                </div>
            </div>
            <h4><a href="#category"></a></h4>
        </div>
    </div>

    <section class="content">
        <center>
            <h2 style="color: white !important;">Upcoming Event Registrations</h2>
            <hr style=" border: 2px solid white; border-radius: 20px;">
        </center>
        <ul id="event-list"></ul><br>
        <div class="message" id="message">
        </div>
        <br>
        <center>
            <h2 style="color: white !important;">Past Event Registrations</h2>
            <hr style=" border: 2px solid white; border-radius: 20px;">
        </center>
        <ul id="event-list1"></ul><br>
        <div class="row"></div>
        <div class="message" id="message1">
        </div>
        <!-- Popup and overlay for event details -->


    </section>
    <!-- Site footer -->
    <footer>
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <p><i class="fa fa-copyright"></i> Copyright 2023 by 365Connect Community

                        | Design: <a href="https://www.linkedin.com/in/shaheer-ahmad-ch" rel="sponsored"
                            target="_parent">Shaheer Ahmad</a></p>
                </div>
            </div>
        </div>
    </footer>
    <script>

        const sidesDiv1 = document.querySelector(".main-menu");
        const link = document.createElement("a");
        link.style.textDecoration = "none";
        var listItem = document.createElement("li");
        listItem.className = "active";

        var listItem1 = document.createElement("li");
        // Set the anchor's attributes
        link.href = "./login.html";
        link.className = "external";
        const link1 = document.createElement("a");

        // Set the anchor's attributes
        link1.className = "external";
        link1.textContent = "Sign-Out";
        link1.style.textDecoration = "none";
        link1.addEventListener("click", function (event) {
            event.preventDefault();
            sessionStorage.setItem("name", null);
            sessionStorage.setItem("email", null);
            sessionStorage.setItem("image", null);
            window.location.href = "./login.html";
        });
        if (sessionStorage.getItem("name") == null || sessionStorage.getItem("email") == null || sessionStorage.getItem("email") == 'null' || sessionStorage.getItem("name") == 'null' || sessionStorage.getItem("email") == '' || sessionStorage.getItem("name") == '') {
            link.textContent = "Sign-In";
            listItem.appendChild(link);
            sidesDiv1.appendChild(listItem);
            
            window.location.href = "./login.html"

        }
        else {
            link.textContent = sessionStorage.name.split(' ')[0] + ", Profile";
            listItem.appendChild(link);
            sidesDiv1.appendChild(listItem);
            listItem1.appendChild(link1);
            sidesDiv1.appendChild(listItem1)
        }
        // Get the elements
        const openPopupButton = document.getElementById('file-openPopup1');
        const popup = document.getElementById('imagePopup');
        const previewImage = document.getElementById('previewImage');

        // Open the popup and display the image
        openPopupButton.addEventListener('click', function () {
            event.preventDefault();
            const backgroundImageURL = window.getComputedStyle(openPopupButton).backgroundImage;
            const imageURL = backgroundImageURL.replace('url("', '').replace('")', '');

            popup.style.display = 'block';
            previewImage.src = imageURL;
        });

        // Close the popup
        function closePopup() {
            popup.style.display = 'none';
        }

        // Close the popup when clicking outside of the image
        window.addEventListener('click', function (event) {
            if (event.target === popup) {
                closePopup();
            }
        });

        var crmUrl = "https://dev-shaheer.crm5.dynamics.com/";
        const authorElement = document.querySelector('.author1');
        console.log(sessionStorage.getItem("image"))
        if (sessionStorage.getItem("image") == '' || sessionStorage.getItem("image") == null || sessionStorage.getItem("image") == 'null' || sessionStorage.getItem("image") == 'undefined') {
            authorElement.style.background = 'url(https://static.vecteezy.com/system/resources/thumbnails/005/545/335/small/user-sign-icon-person-symbol-human-avatar-isolated-on-white-backogrund-vector.jpg) center no-repeat';
        }
        else {
            authorElement.style.background = `url(data:image/png;base64,${sessionStorage.getItem("image")}) center no-repeat`;
        }


        // Change the background image URL


        // Optionally, you can also specify background size and box shadow here
        authorElement.style.backgroundSize = 'cover';
        authorElement.style.boxShadow = '0 2px 3px rgba(0, 0, 0, 0.3)';
        const sidesDiv = document.querySelector(".sides");
        const anchorElement1 = document.createElement("a");

        // Set the anchor's attributes
        anchorElement1.href = "./login.html";
        anchorElement1.className = "logo";
        anchorElement1.style.marginTop = "0px";
        anchorElement1.style.height = "40px";
        anchorElement1.textContent = "Sign Out";
        anchorElement1.addEventListener("click", function (event) {
            event.preventDefault();
            sessionStorage.setItem("name", null);
            sessionStorage.setItem("email", null);
            sessionStorage.setItem("image", null);
            window.location.href = "./index.html";
        });
        sidesDiv.appendChild(anchorElement1);
        // Wrap your code in an async function
        async function fetchDataAndDisplay() {
            const url_string = window.location.href;
            const url = new URL(url_string);
            //   const email = url.searchParams.get("email");
            //   const fullname = url.searchParams.get("name");
            const email = sessionStorage.getItem("email");
            const fullname = sessionStorage.getItem("name");
            const heading = document.getElementById("info");
            const text = document.createElement("h2");
            const textsds = document.createElement("p");
            text.textContent = "Welcome, " + fullname;
            text.innerHTML = ` ${fullname} <i class="fa fa-pencil" style="font-size:20px;" id="file-openPopup1"></i>`;
            textsds.textContent = email;
            text.style.padding = "0px"
            heading.appendChild(text);
            heading.appendChild(textsds);
            // Create headers with the email value
            const myHeaders = new Headers();
            myHeaders.append("email", email);

            const requestOptions = {
                method: 'GET',
                headers: myHeaders,
                redirect: 'follow'
            };

            const apiUrl = "https://prod-10.southeastasia.logic.azure.com:443/workflows/252f1afb2e2943abb0e38c820d33274b/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=8YhfmzychMhNg8o8e1nZpIIpgFHljJoY1LlqNXP9BjM";

            try {
                const events = await fetchEventData(apiUrl, requestOptions);

                // Display event list
                displayEventList(events);
            } catch (error) {
                console.log(error)
            } finally {
                document.getElementById("loading").style.display = "none";
            }

            // Function to fetch event data from the API
            async function fetchEventData(apiUrl, requestOptions) {
                try {
                    const response = await fetch(apiUrl, requestOptions);

                    if (response.status === 200) {
                        const data = await response.json();
                        return data;
                    } else {
                        showError("No Events Registered", "danger");
                    }
                } catch (error) {
                    showError("No Events Registered", "danger");
                }
            }


            // Function to create and display the event list
            function displayEventList(events) {
                const eventList = document.getElementById("event-list");
                const eventList1 = document.getElementById("event-list1");

                events.forEach(event => {
                    const listItem = document.createElement("li");
                    listItem.className = "event-item";
                    if (event["statuscode@OData.Community.Display.V1.FormattedValue"] != 'Pending') {
                        //                     listItem.innerHTML = `<h1>${event["_sa_event_value@OData.Community.Display.V1.FormattedValue"]}</h1>
                        //   <p><strong>Registered On:</strong> ${event["createdon@OData.Community.Display.V1.FormattedValue"]}</p>
                        //   <p><strong>Attendee Name:</strong> ${event["_sa_attendee_value@OData.Community.Display.V1.FormattedValue"]}</p>
                        //   <p><strong>Attendance:</strong> ${event["statuscode@OData.Community.Display.V1.FormattedValue"]}</p><br>
                        //   <a href="./register.html?id=${event._sa_event_value}&reg=false" class="view-details" style="text-decoration: none !important;">View Details</a>
                        // `;
                        //                     eventList1.appendChild(listItem);
                        const parentElement = document.querySelector('.row');
                        const colSm6 = createColSm6(event);
                        parentElement.appendChild(colSm6);
                    } else {
                        listItem.innerHTML = `<h1>${event["_sa_event_value@OData.Community.Display.V1.FormattedValue"]}</h1>
      <p><strong>Registered On:</strong> ${event["createdon@OData.Community.Display.V1.FormattedValue"]}</p>
      <p><strong>Attendee Name:</strong> ${event["_sa_attendee_value@OData.Community.Display.V1.FormattedValue"]}</p>
      <p><strong>Attendance:</strong> ${event["statuscode@OData.Community.Display.V1.FormattedValue"]}</p><br>
      <a href="./register.html?id=${event._sa_event_value}&reg=false" class="view-details" style="text-decoration: none !important;">View Details</a>
    `;
                        eventList.appendChild(listItem);
                    }



                });
                const pendingEvents = events.filter(event => event["statuscode@OData.Community.Display.V1.FormattedValue"] === "Pending");
                const pendingEventCount = pendingEvents.length;
                const pendingEvents1 = events.filter(event => event["statuscode@OData.Community.Display.V1.FormattedValue"] != "Pending");
                const pendingEventCount1 = pendingEvents1.length;
                if (pendingEventCount == 0)
                    showError("No Upcoming Events Registered", "warning");
                if (pendingEventCount1 == 0)
                    showError1("No Past Events Registered", "warning");
            }

            // Function to convert hours to days
            function hoursToDays(hours) {
                if (hours >= 24) {
                    const days = Math.floor(hours / 24);
                    const remainingHours = hours % 24;
                    if (remainingHours !== 0) {
                        return `${days} days and ${remainingHours} hours`;
                    } else {
                        return `${days} days`;
                    }
                } else {
                    return `${hours} hours`;
                }
            }
        }
        function showError(alert, alertType) {
            var message = document.getElementById("message");
            var messagetext = document.createElement("div");
            messagetext.classList.add("alert")
            messagetext.classList.add("alert-" + alertType)
            messagetext.textContent = alert;
            message.appendChild(messagetext);
        }
        function showError1(alert, alertType) {
            var message = document.querySelector('.row');
            var messagetext = document.createElement("div");
            messagetext.classList.add("alert")
            messagetext.classList.add("alert-" + alertType)
            messagetext.textContent = alert;
            message.appendChild(messagetext);
        }

        // Call the async function to initiate the asynchronous operation
        fetchDataAndDisplay();


        function createColSm6(thisevent) {
            // Create a div element with the "col-sm-6" class
            const colDiv = document.createElement('div');
            colDiv.classList.add('col-sm-6');

            // Create a div element with the "card" class
            const cardDiv = document.createElement('div');
            cardDiv.style.boxShadow = "rgba(0, 0, 0, 0.24) 0px 3px 8px";
            cardDiv.classList.add('card', 'd-flex', 'flex-column');
            cardDiv.style.minHeight = '350px';
            cardDiv.style.margin = '10px';
            cardDiv.style.border = "none";
            cardDiv.style.marginBottom = "20px";


            // Create a div element with the "card-body" class
            const cardBodyDiv = document.createElement('div');
            cardBodyDiv.classList.add('card-body');
            cardBodyDiv.style.backgroundColor = "#202124";
            cardBodyDiv.style.borderColor = "#202124 !important";

            // Create a title element
            const titleElement = document.createElement('h2');
            titleElement.classList.add('card-title');
            titleElement.style.backgroundColor = "#131e32";
            titleElement.style.color = "white";
            titleElement.style.height = "150px";
            titleElement.textContent = thisevent["_sa_event_value@OData.Community.Display.V1.FormattedValue"];

            // Create a paragraph element for text
            const textElement = document.createElement('p');
            textElement.classList.add('card-text');
            textElement.style.textAlign = "center";
            textElement.innerHTML = `<b>Registered On: </b>` + thisevent["createdon@OData.Community.Display.V1.FormattedValue"];

            const textElement1 = document.createElement('p');
            textElement1.classList.add('card-text');
            textElement1.style.textAlign = "center";
            textElement1.innerHTML = `<b>Attendee Name: </b>` + thisevent["_sa_attendee_value@OData.Community.Display.V1.FormattedValue"];

            const textElement2 = document.createElement('p');
            textElement2.classList.add('card-text');
            textElement2.style.textAlign = "center";
            textElement2.innerHTML = `<b>Attendance: </b>` + thisevent["statuscode@OData.Community.Display.V1.FormattedValue"];

            // Create a button element
            const buttonElement = document.createElement('p');
            buttonElement.classList.add('view-details');
            buttonElement.style.backgroundColor = "#343a40";
            buttonElement.style.textAlign = "center"
            buttonElement.textContent = 'View Event';

            // Add a click event listener to the button
            buttonElement.addEventListener("click", () => {
                window.location.href = "./register.html?id=" + thisevent._sa_event_value + "&reg=false";
            });

            // Append the button element to the card body
            cardBodyDiv.appendChild(buttonElement);

            // Append elements to build the structure
            cardBodyDiv.appendChild(titleElement);
            cardBodyDiv.appendChild(textElement);
            cardBodyDiv.appendChild(textElement1);
            cardBodyDiv.appendChild(textElement2);
            cardBodyDiv.appendChild(buttonElement);
            cardDiv.appendChild(cardBodyDiv);
            colDiv.appendChild(cardDiv);

            // Return the created col-sm-6 element
            return colDiv;
        }


        ////////
        const fileOpenPopupButton = document.getElementById('file-openPopup');
        const fileUploadPopup = document.getElementById('file-fileUploadPopup');
        const fileInput = document.getElementById('file-fileInput');
        const uploadButton = document.getElementById('file-uploadButton');
        const closePopupButton = document.getElementById('file-closePopup');
        const selectedFileName = document.getElementById('file-selectedFileName');

        // Prevent default navigation behavior
        fileOpenPopupButton.addEventListener('click', (event) => {
            event.preventDefault();
            fileUploadPopup.style.display = 'flex';
        });

        closePopupButton.addEventListener('click', () => {
            fileUploadPopup.style.display = 'none';
        });

        fileInput.addEventListener('change', () => {
            if (fileInput.files.length > 0) {
                selectedFileName.textContent = `Selected File: ${fileInput.files[0].name}`;
            } else {
                selectedFileName.textContent = '';
            }
        });

        uploadButton.addEventListener('click', () => {
            document.getElementById("loading").style.display = "block";
            const selectedFile = fileInput.files[0];
            const userEmail = sessionStorage.getItem("email"); // Replace with the actual user's email

            if (selectedFile) {
                const formData = new FormData();
                formData.append('contents', selectedFile);

                const headers = new Headers();
                headers.append('email', userEmail);

                // Add other headers as needed

                // Replace 'your-api-endpoint' with the actual API endpoint
                fetch('https://prod-26.southeastasia.logic.azure.com:443/workflows/6205a3aedd854dac93fe8b0c6f760ec8/triggers/manual/paths/invoke?api-version=2016-06-01&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=jbGar-dsbKN5DJIqlT7V6-RplSxRkEpnkIG3abjQJaU', {
                    method: 'POST',
                    body: formData,
                    headers: headers
                })
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }
                        return response.json();
                        document.getElementById("loading").style.display = "none";
                    })
                    .then(data => {
                        let newimage_url = data.body.entityimage;
                        authorElement.style.background = `url(data:image/png;base64,${data.body.entityimage}) center no-repeat`
                        fileUploadPopup.style.display = 'none';
                        document.getElementById("loading").style.display = "none";
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        document.getElementById("loading").style.display = "none";
                    });
            } else {
                alert('Please select a file to upload.');
                document.getElementById("loading").style.display = "none";
            }
        });

// $('.nav li:first').addClass('active');

//         var showSection = function showSection(section, isAnimate) {
//           var
//           direction = section.replace(/#/, ''),
//           reqSection = $('.section').filter('[data-section="' + direction + '"]'),
//           reqSectionPos = reqSection.offset().top - 0;

//           if (isAnimate) {
//             $('body, html').animate({
//               scrollTop: reqSectionPos },
//             800);
//           } else {
//             $('body, html').scrollTop(reqSectionPos);
//           }

//         };

//         var checkSection = function checkSection() {
//           $('.section').each(function () {
//             var
//             $this = $(this),
//             topEdge = $this.offset().top - 80,
//             bottomEdge = topEdge + $this.height(),
//             wScroll = $(window).scrollTop();
//             if (topEdge < wScroll && bottomEdge > wScroll) {
//               var
//               currentId = $this.data('section'),
//               reqLink = $('a').filter('[href*=\\#' + currentId + ']');
//               reqLink.closest('li').addClass('active').
//               siblings().removeClass('active');
//             }
//           });
//         };

//         $('.main-menu, .scroll-to-section').on('click', 'a', function (e) {
//           if($(e.target).hasClass('external')) {
//             return;
//           }
//           e.preventDefault();
//           $('#menu').removeClass('active');
//           showSection($(this).attr('href'), true);
//         });

//         $(window).scroll(function () {
//           checkSection();
//         });
    </script>


</body>

</html>